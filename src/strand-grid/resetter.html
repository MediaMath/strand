<!DOCTYPE html>
<html>
<head>
	<script language="javascript" src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
	<link rel="import" href="strand-grid.html">
	<style type="text/css">
		html, body {
			padding: 0;
			margin: 0;
			background: #eee;
			width: 100%;
			height: 100%;
			min-height: 100%;
		}
		*[unresolved] {
			display: none;
		}
		.container {
			width: 800px;
			height: 317px;
		}
		strand-grid {
			width: 800px;
			height: 317px;
		}
		strand-grid[unresolved] {
			display: none;
		}
	</style>
</head>
<body>
	<div class="container">
		<strand-grid id="mmTestGrid" selectable expandable="false" unresolved>
			<strand-grid-column field="id">Id</strand-grid-column>
			<strand-grid-column field="name" >Name</strand-grid-column>
			<strand-grid-column field="advertiser">Advertiser</strand-grid-column>
			<template preserve-content>
				<strand-grid-item model="{{model}}" scope="{{scope}}" on-click="rowClickHandler">
					<div field="id">
						{{model.id}}
					</div>
					<div field="name">
						{{model.name}}
					</div>
					<div field="advertiser">
						{{model.advertiser}}
					</div>
				</strand-grid-item>
			</template>
		</strand-grid>
	</div>
	<script type="text/javascript">
		var bigData = null,
			grid, 
			NUM_ITEMS = 333,
			scrollTop = 0;
		function randomString() {
			var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";
			var string_length = 16;
			var randomString = '';
			for (var i=0; i<string_length; i++) {
				var rnum = Math.floor(Math.random() * chars.length);
				randomString += chars.substring(rnum, rnum+1);
			}
			return randomString;
		}
		function initRndData() {
			var data = [];
			for (var i=0; i<NUM_ITEMS; i++) {
				var rndStr = randomString();
				data.push(generateItem(rndStr, i));
			}
			return data;
		}
		function generateItem(rndStr, i) {
			return {
				id: i,
				name: rndStr,
				advertiser: rndStr
			};
		}
		function setGridData(data) {
			var recycler = grid.querySelector('#viewport');
			//grid.set("index", 0);
			grid.set('data', data);
			recycler.addEventListener('presentation-settled', function fn(e) {
				var parentView = window;
				recycler.removeEventListener('presentation-settled', fn);
				recycler.$.pane.scrollTop = parentView.scrollTop;
			});
		}
		function addedGridData(index) {
			var newData = bigData.slice();
			var newItem = generateItem(randomString(), 'NEW');
			// var rndNumNewItems = 10; // should be an actual rnd num
			newData.splice(index+1, 0, newItem);
			return newData;
		}
		function rowClickHandler(e) {
			var parentView = this.scope.parentView;
			var event = Polymer.dom(e);
			var clickedRow = event.rootTarget.offsetParent;
			var index = clickedRow.model.id;
			parentView.scrollTop = clickedRow.scope.$.viewport.$.pane.scrollTop;
			// add some random data in there:
			setGridData(addedGridData(index));
		}
		window.addEventListener("WebComponentsReady", function() {
			var parentView = window;
			var rowClickHandler = window.rowClickHandler;
			bigData = initRndData();
			
			grid = document.querySelector("#mmTestGrid");
			grid.parentView = parentView;
			grid.mixinFindable = {
				mixinsForValuePath: function () {
					return null;
				},
				mixinsForValue: function () {
					return {
						rowClickHandler: rowClickHandler
					}
				}
			};
			setGridData(bigData);
		});
	</script>
</body>
</html>