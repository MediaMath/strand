<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<script src="../bower_components/webcomponentsjs/webcomponents.js"></script>
		<script src="../bower_components/web-component-tester/browser.js"></script>
		<script src="TestHelper.js"></script>
		<script>
			var should = chai.should();
		</script>
		<link rel="import" href="../build/shared/behaviors/sizeresponsible.html"/>
		<link rel="import" href="../build/shared/js/datautils.html"/>
		<link rel="import" href="../bower_components/polymer/polymer.html"/>
	</head>
	<body>
		<dom-module id="test-sizeresponsible">
			<template>
				<div id="listItem"></div>
			</template>
			<style>
				:host {
					display: block;
					position: relative;
				}
				#listItem {
					background: #ff0000;
					width: 100%;
					height: 29px;
				}
			</style>
			<script>
				HTMLImports.whenReady(function() {
					Polymer({
						is:"test-sizeresponsible",

						behaviors:[StrandTraits.SizeResponsible],

						properties: {
							_responders: {
								type: Object,
								value: function () {
									var responders = {};
									responders.resizeCallback = this.resizeCallback.bind(this);
									return responders;
								}
							}
						},

						attached: function() {
							this.addResizeListener(this._responders.resizeCallback, this.$.listItem);
						},

						detached: function() {
							this.removeResizeListener(this._responders.resizeCallback, this.$.listItem);
						},

						resizeCallback: function() {
							this.resizeCallbackCalled();
						},

						resizeCallbackCalled: function() {
							console.log('resizeCallbackCalled');
						},

						resize: function(int) {
							this.$.listItem.style.height = int + 'px';
						}
					});
				});
			</script>
		</dom-module>

		<test-sizeresponsible id="test1"></test-sizeresponsible>
		
		<script>
			describe("SizeResponsible", function() {
				
				it("should exist", function() {
					StrandTraits.should.be.an.object;
					StrandTraits.SizeResponsible.should.be.an.object;
				});

				it("should contain a div with an iframe size responder", function() {
					var t = document.querySelector("#test1");
					var d = Polymer.dom(t.$.listItem).querySelector("div");
					var iframe = Polymer.dom(d).querySelector("iframe");

					d.should.exist;
					iframe.should.exist;
				});

				// it("should respond to resizing", function(done) {
				// 	var t = document.querySelector("#test1");
				// 	var iframe = Polymer.dom(t).querySelector("iframe");
				// 	// sinon can't actually 'spy' on the caller of the callback
				// 	var s = sinon.spy(t, "resizeCallbackCalled");

				// 	t.resize(100);

				// 	t.async(function(){
				// 		should.equal(s.calledOnce, true);
				// 		done();
				// 	}, 150);
				// });

				it("should remove the listener when removed", function(done) {
					var t = document.querySelector("#test1");
					var l = t._listeners;

					Polymer.dom(document.body).removeChild(t);

					flush(function(){
						should.equal(l.length, 0);
						done();
					});
				});

			});

		</script>

	</body>
</html>