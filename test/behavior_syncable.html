<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<script src="../bower_components/webcomponentsjs/webcomponents.js"></script>
	<script src="../bower_components/web-component-tester/browser.js"></script>
	<script>
		var should = chai.should();
	</script>
	<link rel="import" href="../shared/behaviors/syncable.html"/>
	<link rel="import" href="../bower_components/polymer/polymer.html"/>
</head>
<body>
	<dom-module id="test-syncable">
		<template>
			<content id="content"></content>
		</template>
	</dom-module>
	<script>
	/*jshint -W030 */

	var SyncTest = Polymer({
		is:"test-syncable",
		behaviors:[StrandTraits.Syncable],
	});

	/** begin tests **/

	describe("syncable", function() {

		it("should exist", function() {
			StrandTraits.should.be.an.object;
			StrandTraits.Syncable.should.be.an.array;
		});

		it("should support global storage", function() {

			var sync = new SyncTest();
			sync.auto = false;
			sync.should.have.property("_csrf");
			sync.should.have.property("_globals");
			sync._csrf.should.be.an.instanceof(StrandLib.Storage);
			sync._globals.should.be.an.instanceof(StrandLib.Storage);

			sync.setGlobal.should.be.a.function;
			sync.getGlobal.should.be.a.function;

			sync.setGlobal("abcd","test");
			sync.getGlobal("abcd").should.equal("test");

			var sync2 = new SyncTest();
			sync2.auto = false;
			sync2.getGlobal("abcd").should.equal("test");

		});

		it("should have an ajax instance", function() {

			var sync = new SyncTest();
			sync.auto=false;
			sync.should.have.property("_ajax");
			sync._ajax.should.be.an.instanceof(StrandLib.Ajax);


		});

		it("should support basic calls", function() {

			var xhr = sinon.useFakeXMLHttpRequest();

			var sync = new SyncTest();
			sync.auto = false;
			sync.get.should.be.a.function;
			sync.post.should.be.a.function;
			sync.put.should.be.a.function;
			sync.delete.should.be.a.function;

			sync.get().should.be.instanceof(Zousan);
			sync.post().should.be.instanceof(Zousan);
			sync.put().should.be.instanceof(Zousan);
			sync.delete().should.be.instanceof(Zousan);

			xhr.restore();

		});

		it("should implement basic CSRF support", function() {

			var sync = new SyncTest();
			sync.auto = false;
			sync.csrf = true;
			sync.cacheCsrf = true;

			var xhr = sinon.useFakeXMLHttpRequest();
			var request;
			xhr.onCreate = function(req) {
				request = req;
			};

			var a = new StrandLib.Ajax();
			var mock = {
				instance:a
			};
			a.exec({},{url:"//test.com"});
			request.respond(200, 
				{ 
					"Content-Type": "application/json",
					"X-CSRF-Token":"abcdefghijklmnopqrst"
				},
				'[{ "id": 12, "comment": "Hey there" }]'
			);

			sync._getCSRFHeader(mock);
			sync.csrfToken.should.equal("abcdefghijklmnopqrst");
			sync._csrf.value.should.equal("abcdefghijklmnopqrst");

			var test = [];
			sync._setCSRFHeader(StrandLib.Ajax.GET, test);
			test.should.have.length(1);
			test[0].should.deep.equal({
				name:"X-CSRF-Token",
				value:"abcdefghijklmnopqrst"
			});

			xhr.restore();

		});

		it("should support adding a manual cachebust for older servers", function() {
			var xhr = sinon.useFakeXMLHttpRequest();
			var request;
			xhr.onCreate = function(req) {
				request = req;
			};
			var sync = new SyncTest();
			sync.auto = false;
			sync.cacheBuster = true;
			sync.get();

			request.url.should.contain("/?nocache=");

			sync.cacheBuster = "testBust";
			sync.get();
			request.url.should.contain("/?testBust=");

			xhr.restore();
		});

	});
	</script>
	<!-- <test-syncable auto="false"></test-syncable> -->
</body>
</html>